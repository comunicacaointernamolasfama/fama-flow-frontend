<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fama Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --color-background: #F9F9F9; --color-surface: #FFFFFF; --color-text-primary: #1E1E1E; --color-text-secondary: #6B7280; --color-brand-primary: #D81920; --color-border: #E0E0E0; --color-success: #10B981; --color-warning: #F59E0B; --color-danger: #D81920; --color-info: #3B82F6; --color-success-bg: #E7F8F2; --color-warning-bg: #FFFBEB; --color-danger-bg: #FEF2F2; --color-info-bg: #EFF6FF; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --read-bg: #f3f4f6; --unread-bg: #FFFFFF;
        }
        body.dark-mode {
            --color-background: #121212; --color-surface: #1E1E1E; --color-text-primary: #FFFFFF; --color-text-secondary: #A8A8A8; --color-border: #383838; --color-success-bg: #052e16; --color-warning-bg: #2a2105; --color-danger-bg: #3b1212; --color-info-bg: #1e293b; --shadow: none;
            --read-bg: #1a1a1a; --unread-bg: #252525;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--color-background); color: var(--color-text-primary); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        * { box-sizing: border-box; }
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; }
        .theme-toggle { position: fixed; top: 1.5rem; right: 1.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow); z-index: 3000; }
        .theme-toggle .material-icons { color: var(--color-text-secondary); }
        #icon-sun { display: none; } body.dark-mode #icon-sun { display: block; } body.dark-mode #icon-moon { display: none; }
        .login-container { width: 100%; max-width: 400px; padding: 2.5rem; text-align: center; background-color: var(--color-surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--color-border); }
        .login-logo { max-width: 180px; margin-bottom: 1rem; }
        .login-subtitle { color: var(--color-text-secondary); margin-bottom: 2.5rem; font-size: 1rem; }
        .input-group { position: relative; margin-bottom: 1.5rem; text-align: left;}
        .input-field { width: 100%; padding: 1rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text-primary); font-size: 1rem; }
        .btn-primary { padding: 1rem; border: none; border-radius: 8px; background-color: var(--color-brand-primary); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity: 0.2s; }
        #app-container, .login-wrapper { display: none; }
        #app-container.visible, .login-wrapper.visible { display: flex; }
        .sidebar { width: 260px; background-color: var(--color-surface); border-right: 1px solid var(--color-border); padding: 1.5rem; display: flex; flex-direction: column; height: 100vh; position: fixed; }
        .sidebar-header { margin-bottom: 2rem; } .sidebar-logo { width: 120px; }
        .nav-menu { list-style: none; padding: 0; margin: 0; } .nav-menu li { margin-bottom: 0.5rem; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; color: var(--color-text-secondary); font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .nav-link .material-icons { margin-right: 1rem; }
        .nav-link:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .nav-link.active { background-color: var(--color-brand-primary); color: white; }
        .nav-section-title { font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase; margin: 2rem 0 1rem 1rem; font-weight: 600; }
        .sidebar-footer { margin-top: auto; }
        main.content { flex: 1; margin-left: 260px; padding: 2rem 3rem; overflow-y: auto; background-color: var(--color-background); position: relative; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-header h1 { margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 1rem;} .page-header p { margin: 5px 0 0 0; color: var(--color-text-secondary); }
        .page-header-actions { display: flex; align-items: center; gap: 1rem; }
        .page-content { display: none; } .page-content.active { display: block; }
        .card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
        .grid { display: grid; gap: 1.5rem; } .grid-cols-2 { grid-template-columns: repeat(2, 1fr); } .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; border: none; transition: background-color 0.2s, opacity 0.2s;}
        .btn:hover { opacity: 0.9; } .btn .material-icons { margin-right: 0.5rem; font-size: 20px; }
        .btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .btn-icon { padding: 0.5rem; background: none; border: none; color: var(--color-text-secondary); border-radius: 50%; line-height: 1;} .btn-icon:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        .btn-danger { background-color: var(--color-brand-primary); color: white; }
        .btn-success { background-color: var(--color-success); color: white; } .btn-warning { background-color: var(--color-warning); color: white; }
        .fab { position: fixed; right: 3rem; bottom: 3rem; width: 56px; height: 56px; background-color: var(--color-brand-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: pointer; border: none; z-index: 100; transition: transform 0.2s; } .fab:hover { transform: scale(1.05); }
        .fab.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--color-surface); padding: 0; border-radius: 12px; width: 100%; max-width: 500px; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); }
        .modal-body { padding: 1.5rem; } .modal-footer { padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; background-color: var(--color-background); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .stat-card { display: flex; align-items: center; gap: 1rem; }
        .stat-card .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card.card-warning .stat-icon { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .stat-card.card-danger .stat-icon { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .stat-card .stat-info h3 { margin: 0; font-size: 1rem; color: var(--color-text-secondary); }
        .stat-card .stat-info p { margin: 0; font-size: 2rem; font-weight: 700; }
        .page-header .btn { padding: 0.5rem 1rem; }
        .message-actions-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-right: 1rem; }
        .tabs-container { display: flex; gap: 0.5rem; }
        .tab-link { background: none; border: none; padding: 0.75rem 1.25rem; cursor: pointer; color: var(--color-text-secondary); font-weight: 500; border-bottom: 2px solid transparent; }
        .tab-link.active { color: var(--color-brand-primary); border-bottom-color: var(--color-brand-primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .empty-state { padding: 3rem 1rem; text-align: center; color: var(--color-text-secondary); }
        .data-table-fino { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .data-table-fino tr { cursor: pointer; transition: background-color 0.2s; }
        .data-table-fino tr.row-unread { background-color: var(--unread-bg); }
        .data-table-fino tr.row-read { background-color: var(--read-bg); }
        .data-table-fino tr:hover { filter: brightness(0.98); }
        .data-table-fino td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; white-space: nowrap; }
        .data-table-fino .col-who { width: 20%; font-weight: 400; overflow: hidden; text-overflow: ellipsis; color: var(--color-text-primary); }
        .row-unread .col-who { font-weight: 700; color: var(--color-text-primary); }
        .data-table-fino .col-subject { width: 50%; overflow: hidden; text-overflow: ellipsis; }
        .data-table-fino .subject-title { font-weight: 400; color: var(--color-text-primary); }
        .row-unread .subject-title { font-weight: 700; }
        .data-table-fino .subject-preview { color: var(--color-text-secondary); margin-left: 0.5rem; font-weight: 400; }
        .data-table-fino .col-meta { width: 15%; text-align: right; }
        .data-table-fino .col-meta .meta-tags { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; }
        .data-table-fino .col-date { width: 10%; text-align: right; color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 400; }
        .row-unread .col-date { font-weight: 600; color: var(--color-text-primary); }
        .data-table-fino .col-actions { width: 5%; text-align: center; }
        .data-table-fino .col-actions button { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 4px; border-radius: 50%; }
        .data-table-fino .col-actions button:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .tag-fino { font-size: 0.7rem; font-weight: 600; padding: 0.15rem 0.6rem; border-radius: 12px; margin-left: 0.5rem; display: inline-block; line-height: 1.2; vertical-align: middle; }
        .tag-fino.tag-urgent { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .tag-fino.tag-important { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .tag-icon { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; color: var(--color-text-secondary); }
        .tag-icon .material-icons { font-size: 18px; }
        .due-date-tag { font-weight: 500; color: var(--color-text-primary); }
        .read-receipt { display: inline-flex; vertical-align: middle; margin-right: 8px; }
        .read-receipt .material-icons { font-size: 18px; }
        .read-receipt.read .material-icons { color: var(--color-info); }
        .read-receipt.delivered .material-icons { color: var(--color-text-secondary); opacity: 0.6; }
        .refresh-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; line-height: 1; }
        .refresh-btn:hover { background-color: var(--color-background); }
        .refresh-btn .material-icons { color: var(--color-text-secondary); transition: transform 0.3s; }
        .refresh-btn:hover .material-icons { color: var(--color-text-primary); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .refresh-btn.loading .material-icons { animation: spin 1s linear infinite; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); }
        .data-table thead th { background-color: var(--color-background); font-weight: 600; color: var(--color-text-secondary); font-size: 0.9rem; }
        .user-info-cell { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--color-info-bg); color: var(--color-info); display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
        .user-info-cell .user-name { font-weight: 600; }
        .user-info-cell .user-email { font-size: 0.9rem; color: var(--color-text-secondary); }
        .user-meta-cell { display: flex; flex-direction: column; gap: 0.25rem; }
        .user-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .user-tag { font-size: 0.75rem; font-weight: 600; padding: 0.15rem 0.6rem; border-radius: 12px; display: inline-flex; align-items: center; gap: 0.25rem; }
        .user-tag.department { background-color: var(--color-info-bg); color: var(--color-info); }
        .user-tag.role-admin { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .user-tag.role { background-color: var(--color-background); color: var(--color-text-secondary); border: 1px solid var(--color-border); }
        .score-cell { font-weight: 600; display: flex; align-items: center; gap: 0.25rem; text-align: left !important; }
        .score-cell .material-icons { color: var(--color-warning); font-size: 18px; }
        .action-buttons { text-align: right; }
        .action-buttons .btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 4px; border-radius: 50%; }
        .action-buttons .btn:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        #profile-page .page-header { margin-bottom: 1rem; }
        .profile-header-card { text-align: center; background-color: transparent; border: none; box-shadow: none; padding: 0; margin-bottom: 2rem; }
        .profile-avatar-wrapper { position: relative; display: inline-block; }
        .profile-header-card .profile-avatar { width: 80px; height: 80px; font-size: 2.5rem; margin-bottom: 1rem; cursor: pointer; }
        .profile-avatar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; opacity: 0; transition: opacity 0.3s; }
        .profile-avatar-wrapper:hover .profile-avatar-overlay { opacity: 1; }
        .profile-header-card .profile-info h3 { margin: 0; font-size: 1.5rem; }
        .profile-header-card .profile-info p { margin: 0.25rem 0 0; color: var(--color-text-secondary); }
        .card-title { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
        .card-title .material-icons { color: var(--color-brand-primary); }
        .progress-bar-container { width: 100%; background-color: var(--color-background); border-radius: 8px; overflow: hidden; height: 12px; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--color-brand-primary); border-radius: 8px; transition: width 0.5s ease-out; }
        .score-display { display: flex; justify-content: space-between; align-items: baseline; margin-top: 0.5rem; }
        .score-display .score-value { font-size: 1.2rem; font-weight: 700; }
        .score-display .score-label { font-size: 0.9rem; color: var(--color-text-secondary); }
        .profile-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center; margin-top: 1.5rem; }
        .profile-metric h4 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .profile-metric p { margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--color-text-secondary); }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; text-align: center; }
        .achievement-badge { opacity: 0.4; }
        .achievement-badge.unlocked { opacity: 1; }
        .achievement-badge .badge-icon { font-size: 48px; color: var(--color-warning); }
        .achievement-badge p { font-weight: 500; margin: 0.5rem 0 0; font-size: 0.9rem; }
        #new-message-popup { position: fixed; bottom: 0; right: 3rem; width: 600px; max-width: 90vw; background-color: var(--color-surface); border: 1px solid var(--color-border); border-top-left-radius: 12px; border-top-right-radius: 12px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 1001; display: none; flex-direction: column; transition: transform 0.3s ease-out; transform: translateY(100%); }
        #new-message-popup.visible { display: flex; transform: translateY(0); }
        .popup-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--color-background); border-bottom: 1px solid var(--color-border); cursor: move; }
        .popup-header h3 { margin: 0; font-size: 1rem; }
        #new-message-form { display: flex; flex-direction: column; height: 500px; max-height: 70vh; }
        .popup-body { padding: 0.5rem 1rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .popup-body .form-group { margin: 0; }
        .popup-body .input-field { background: transparent; border: none; border-bottom: 1px solid var(--color-border); border-radius: 0; padding: 0.75rem 0; font-size: 0.9rem; }
        .popup-body .input-field:focus { outline: none; border-bottom-color: var(--color-info); }
        .ql-editor.ql-blank::before { color: var(--color-text-secondary); font-style: normal; pointer-events: none; }
        #editor-wrapper { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #editor-wrapper .ql-toolbar { flex-shrink: 0; border-bottom: 1px solid var(--color-border) !important; }
        #editor-wrapper .ql-container.ql-snow { border: none !important; flex-grow: 1; overflow-y: auto; }
        #recipient-group { position: relative; margin-bottom: 1.5rem !important;}
        #recipient-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; z-index: 1002; max-height: 200px; overflow-y: auto; display: none; box-shadow: var(--shadow); }
        .suggestion-item { padding: 0.5rem 1rem; cursor: pointer; }
        .suggestion-item:hover { background-color: var(--color-background); }
        .popup-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .popup-footer-top-row { display: flex; justify-content: space-between; align-items: center; min-height: 38px; }
        .popup-footer-main { display: flex; justify-content: space-between; align-items: center; }
        .popup-actions-left { display: flex; align-items: center; gap: 1rem; }
        #attachment-preview { font-size: 0.8rem; color: var(--color-text-secondary); background-color: var(--color-background); padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-flex; align-items: center; gap: 0.5rem; }
        #attachment-preview .remove-attachment { cursor: pointer; }
        .message-type-selector { display: flex; gap: 0.5rem; border: 1px solid var(--color-border); border-radius: 8px; padding: 0.25rem; background-color: var(--color-background);}
        .message-type-selector label { flex: 1; display: block; text-align: center; padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; }
        .message-type-selector input[type="radio"] { display: none; }
        .message-type-selector input[type="radio"]:checked + label { background-color: var(--color-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 600; }
        .urgency-selector { display: flex; gap: 0.5rem; }
        .urgency-selector .btn { font-size: 0.8rem; padding: 0.4rem 0.8rem; border-radius: 20px; }
        .custom-checkbox { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
        .custom-checkbox input[type="checkbox"] { display: none; }
        .custom-checkbox .checkbox-box { width: 18px; height: 18px; border: 2px solid var(--color-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .custom-checkbox .checkbox-box .material-icons { font-size: 14px; color: white; transform: scale(0); transition: transform 0.2s; }
        .custom-checkbox input[type="checkbox"]:checked + .checkbox-box { background-color: var(--color-info); border-color: var(--color-info); }
        .custom-checkbox input[type="checkbox"]:checked + .checkbox-box .material-icons { transform: scale(1); }
        #chamado-fields { display: flex; align-items: center; gap: 0.75rem; }
        #chamado-fields label { font-size: 0.9rem; margin-bottom: 0; color: var(--color-text-secondary); white-space: nowrap; }
        #chamado-fields .input-field { font-size: 0.9rem; padding: 0.4rem 0.8rem; border: 1px solid var(--color-border); background: var(--color-background); }
        #chamado-fields .date-presets { display: flex; gap: 0.25rem; }
        #chamado-fields .date-presets button { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
        #recipient-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; border-bottom: 1px solid var(--color-border); padding: 0.375rem 0; cursor: text; }
        #recipient-input-wrapper:focus-within { border-bottom-color: var(--color-info); }
        .recipient-pill { display: inline-flex; align-items: center; gap: 0.5rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 16px; padding: 0.25rem 0.75rem; font-size: 0.9rem; }
        .recipient-pill .pill-remove { cursor: pointer; font-size: 1rem; font-weight: 700; color: var(--color-text-secondary); }
        #destinatario-input { border: none; outline: none; background: transparent; flex-grow: 1; min-width: 100px; font-size: 0.9rem; padding: 0.375rem 0; }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: var(--color-surface); border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid; min-width: 300px; transform: translateX(120%); opacity: 0; transition: transform 0.4s ease-out, opacity 0.4s ease-out; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast .toast-icon { font-size: 24px; }
        .toast .toast-message { flex: 1; font-weight: 500; font-size: 0.9rem; }
        .toast .toast-close { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; }
        .toast.toast-success { border-color: var(--color-success); background-color: var(--color-success-bg); } .toast.toast-success .toast-icon { color: var(--color-success); }
        .toast.toast-danger { border-color: var(--color-danger); background-color: var(--color-danger-bg); } .toast.toast-danger .toast-icon { color: var(--color-danger); }
        .toast.toast-warning { border-color: var(--color-warning); background-color: var(--color-warning-bg); } .toast.toast-warning .toast-icon { color: var(--color-warning); }
        .toast.toast-info { border-color: var(--color-info); background-color: var(--color-info-bg); } .toast.toast-info .toast-icon { color: var(--color-info); }
        
        /* --- CONVERSATION VIEW REFACTOR --- */
        #conversation-view-page .page-header { flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .conversation-main-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .conversation-info-block { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; padding: 0.75rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; }
        .conversation-info-block h1 { font-size: 1.5rem; margin: 0 0 0.5rem 0; }
        .conversation-info-block p { color: var(--color-text-secondary); margin: 0; }
        .conversation-ticket-info { background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.75rem 1rem; display: flex; justify-content: space-around; align-items: center; font-size: 0.9rem; gap: 1rem; }
        .conversation-ticket-info div { display: flex; align-items: center; gap: 0.5rem; }
        .conversation-ticket-info .tag-fino { font-size: 0.8rem; }
        #conversation-view-page .card { display: flex; flex-direction: column; height: calc(100vh - 16rem); padding: 0; }
        #conversation-messages { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 18px; word-break: break-word; }
        .message-attachment { margin-top: 0.5rem; }
        .message-attachment-link { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: rgba(0,0,0,0.05); border-radius: 8px; text-decoration: none; color: inherit; font-size: 0.9rem; border: 1px solid var(--color-border); }
        .message-attachment-link:hover { background-color: rgba(0,0,0,0.1); }
        .message-bubble.sent .message-attachment-link { background-color: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
        .message-bubble.sent .message-attachment-link:hover { background-color: rgba(255,255,255,0.3); }
        .message-metadata { font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem; }
        .message-bubble-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-bubble-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .message-bubble.sent { background-color: var(--color-brand-primary); color: white; border-bottom-right-radius: 4px; }
        .message-bubble.received { background-color: var(--color-background); border: 1px solid var(--color-border); border-bottom-left-radius: 4px; }
        #reply-form-wrapper { padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); background-color: var(--color-surface); }
        #reply-form { display: flex; gap: 1rem; align-items: center; }
        #reply-input { flex-grow: 1; }
        #reply-attachment-preview { margin-top: 0.5rem; font-size: 0.8rem; }
        
        /* New Styles for Recipient Search Layout */
        .search-row { display: flex; align-items: flex-start; gap: 0.5rem; }
        #recipient-input-wrapper { flex-grow: 1; }
        
        /* New Styles for Recipient Modal */
        #recipient-modal .modal-content { max-width: 700px; height: 80vh; display: flex; flex-direction: column; }
        .filter-row { padding: 1rem; border-bottom: 1px solid var(--color-border); display: flex; gap: 0.75rem; background-color: var(--color-background); align-items: center;}
        .filter-row select, .filter-row input { flex: 1; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; background: var(--color-surface); color: var(--color-text-primary); }
        .recipient-table-container { flex: 1; overflow-y: auto; padding: 0; }
        .recipient-table-container thead { position: sticky; top: 0; background: var(--color-surface); z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .recipient-table-container th { padding: 0.75rem 1rem; text-align: left; font-size: 0.85rem; color: var(--color-text-secondary); font-weight: 600; border-bottom: 1px solid var(--color-border); }
        .selected-row { background-color: var(--color-info-bg); }
        .check-icon { color: var(--color-border); font-size: 24px; }
        .selected-row .check-icon { color: var(--color-success); }
    </style>
</head>
<body>
    <div id="root"></div>
    <button class="theme-toggle" id="theme-toggle" title="Alterar tema" style="display: none;"><span class="material-icons" id="icon-moon">dark_mode</span><span class="material-icons" id="icon-sun">light_mode</span></button>
    <div id="toast-container"></div>
    
    <!-- MAIN MESSAGE POPUP -->
    <div id="new-message-popup"><div class="popup-header"><h3>Nova Mensagem</h3><button onclick="closeNewMessagePopup()"><span class="material-icons">close</span></button></div><form id="new-message-form"><div class="popup-body">
        
        <!-- NEW RECIPIENT LAYOUT -->
        <div class="form-group" id="recipient-group">
            <div class="search-row">
                <div id="recipient-input-wrapper" onclick="document.getElementById('destinatario-input').focus()">
                    <input type="text" id="destinatario-input" placeholder="Digite ou busque ao lado..." autocomplete="off">
                </div>
                <button type="button" class="btn btn-secondary" onclick="openRecipientModal()" title="Abrir Lista Avançada">
                    <span class="material-icons">list</span>
                </button>
            </div>
            <div id="recipient-suggestions"></div>
        </div>

        <div class="form-group"><input type="text" id="assunto" class="input-field" placeholder="Assunto"></div><div id="editor-wrapper"><div id="editor-container"></div></div></div><div class="popup-footer"><div class="popup-footer-top-row"><div class="urgency-selector"><button type="button" class="btn btn-success active" data-priority="normal">Normal</button><button type="button" class="btn btn-secondary" data-priority="important">Importante</button><button type="button" class="btn btn-secondary" data-priority="urgent">Urgente</button></div><div id="chamado-fields" style="display:none;"><label for="due_date">Prazo:</label><input type="date" id="due_date" class="input-field"><div class="date-presets"><button type="button" class="btn btn-secondary" onclick="setDueDate(1)">+1d</button><button type="button" class="btn btn-secondary" onclick="setDueDate(7)">+7d</button></div></div></div><div class="popup-footer-main"><div class="popup-actions-left"><button type="submit" id="btn-send-message" class="btn btn-danger">Enviar</button><input type="file" id="attachment-input" style="display: none;"><button type="button" class="btn btn-icon" onclick="document.getElementById('attachment-input').click()" title="Anexar arquivo"><span class="material-icons">attachment</span></button><div id="attachment-preview"></div><div class="message-type-selector"><div><input type="radio" id="tipo-simples" name="message-type" value="message" checked onchange="toggleChamadoFields()"><label for="tipo-simples">Simples</label></div><div><input type="radio" id="tipo-chamado" name="message-type" value="ticket" onchange="toggleChamadoFields()"><label for="tipo-chamado">Chamado</label></div></div></div><label class="custom-checkbox"><input type="checkbox" id="requires_response"><span class="checkbox-box"><span class="material-icons">check</span></span> Exige Resposta</label></div></div></form></div>

    <!-- NEW RECIPIENT SELECTION MODAL -->
    <div id="recipient-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Selecionar Destinatários</h3>
                <span class="material-icons" style="cursor:pointer;" onclick="closeRecipientModal()">close</span>
            </div>
            
            <div class="filter-row">
                <select id="filter-dept" onchange="applyRecipientFilters()" autocomplete="off">
                    <option value="">Todos Departamentos</option>
                </select>
                <select id="filter-role" onchange="applyRecipientFilters()" autocomplete="off">
                    <option value="">Todos Cargos</option>
                </select>
                <input type="text" id="filter-text" placeholder="Buscar Nome..." oninput="applyRecipientFilters()" autocomplete="off">
            </div>

            <div class="modal-body recipient-table-container">
                <table class="data-table-fino" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Funcionário</th>
                            <th style="width: 30%;">Departamento</th>
                            <th style="width: 20%;">Cargo</th>
                            <th style="width: 10%; text-align: center;">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="recipient-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="modal-footer">
                <div style="flex-grow: 1; font-size: 0.9rem; color: var(--color-text-secondary);" id="selected-count-display">0 selecionados</div>
                <button class="btn btn-danger" onclick="closeRecipientModal()">Concluir Seleção</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://flegnghsopbrulnnpuvz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZWduZ2hzb3BicnVsbm5wdXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc2MjMsImV4cCI6MjA3ODMyMzYyM30.oZN5gJyNemgYT8nKsXwK9y8cYY_SjLR-sfMqZeaOdQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const N8N_CREATE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/create-user';
        const N8N_UPDATE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/update-user';
        const N8N_DELETE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/delete-user';
        const N8N_SEND_MESSAGE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/21446ed7-79bd-4a14-b954-ab729bb61f26';
        const N8N_MARK_AS_READ_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/mark-as-read';
        const N8N_TOGGLE_ARCHIVE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/toggle-archive';
        const N8N_RESOLVE_TICKET_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/resolve-ticket';

        let currentUserProfile = null;
        let quillEditor = null;
        let allUsers = [];
        let selectedRecipients = [];
        let selectedFile = null;

        const root = document.getElementById('root');
        const themeToggleBtn = document.getElementById('theme-toggle');

        const authHTML = `<div class="login-wrapper visible" id="auth-wrapper"><div id="auth-container" class="login-container"><img src="https://ctfamadobrasil.com.br/wp-content/uploads/2025/09/logo.png" alt="Logo Fama" class="login-logo"><p class="login-subtitle">Comunicação interna Molas Fama</p><form id="login-form"><div class="input-group"><input type="email" id="email" class="input-field" placeholder="Email" required></div><div class="input-group"><input type="password" id="password" class="input-field" placeholder="Senha" required></div><button type="submit" class="btn-primary" style="width: 100%;">Entrar</button></form></div></div>`;
        const appHTML = `<div id="app-container"><aside class="sidebar"><div class="sidebar-header"><img src="https://ctfamadobrasil.com.br/wp-content/uploads/2025/09/logo.png" alt="Logo Fama" class="sidebar-logo"></div><ul class="nav-menu"><li><a href="#" class="nav-link" data-page="dashboard-page"><span class="material-icons">dashboard</span> Dashboard</a></li><li><a href="#" class="nav-link" data-page="messages-page"><span class="material-icons">inbox</span> Mensagens</a></li><li><a href="#" class="nav-link" data-page="contacts-page"><span class="material-icons">people</span> Contatos</a></li></ul><div id="admin-section" style="display: none;"><h3 class="nav-section-title">Administração</h3><ul class="nav-menu"><li><a href="#" class="nav-link" data-page="admin-dashboard-page"><span class="material-icons">admin_panel_settings</span> Admin Dashboard</a></li><li><a href="#" class="nav-link" data-page="users-page"><span class="material-icons">group_add</span> Usuários</a></li></ul></div><div class="sidebar-footer"><ul class="nav-menu"><li><a href="#" class="nav-link" data-page="profile-page"><span class="material-icons">account_circle</span> Meu Perfil</a></li><li><a href="#" class="nav-link" id="logout-button"><span class="material-icons">logout</span> Sair</a></li></ul></div></aside><main class="content"><div id="dashboard-page" class="page-content"><div class="page-header"><div><h1 id="dashboard-title">Dashboard</h1><p>Visão geral da sua comunicação interna</p></div></div><div class="grid grid-cols-2"><div class="card stat-card card-warning"><div class="stat-icon"><span class="material-icons">mark_email_unread</span></div><div class="stat-info"><h3>Mensagens Pendentes</h3><p id="pending-messages-count">0</p></div></div><div class="card stat-card card-danger"><div class="stat-icon"><span class="material-icons">report_problem</span></div><div class="stat-info"><h3>Chamados Urgentes</h3><p id="urgent-tickets-count">0</p></div></div></div></div><div id="messages-page" class="page-content"><div class="page-header"><h1>Mensagens</h1></div><div class="message-actions-header"><div class="tabs-container"><button class="tab-link active" data-tab="inbox-content">Caixa de Entrada</button><button class="tab-link" data-tab="sent-content">Enviados</button><button class="tab-link" data-tab="archived-content">Arquivados</button></div><button id="refresh-messages-btn" class="refresh-btn" title="Atualizar mensagens"><span class="material-icons">refresh</span></button></div><div class="card" style="padding: 0; border-top-left-radius: 0; border-top-right-radius: 0;"><div id="inbox-content" class="tab-content active"></div><div id="sent-content" class="tab-content"></div><div id="archived-content" class="tab-content"></div></div></div><div id="conversation-view-page" class="page-content"><div class="page-header" id="conversation-header"></div><div class="card"><div id="conversation-messages">Carregando conversa...</div><div id="reply-form-wrapper"><div id="reply-attachment-preview"></div><form id="reply-form"><input type="file" id="reply-attachment-input" style="display: none;"><button type="button" class="btn btn-icon" onclick="document.getElementById('reply-attachment-input').click()" title="Anexar arquivo"><span class="material-icons">attachment</span></button><input type="text" id="reply-input" class="input-field" placeholder="Digite sua resposta..." required><button type="submit" class="btn btn-danger">Enviar</button></form></div></div></div><div id="contacts-page" class="page-content"><div class="page-header"><h1>Contatos</h1></div><div class="card"><div id="contact-list-content" class="grid grid-cols-3">Carregando contatos...</div></div></div><div id="admin-dashboard-page" class="page-content"><div class="page-header"><h1>Dashboard Administrativo</h1></div><div class="card">Métricas da plataforma aparecerão aqui.</div></div><div id="users-page" class="page-content"><div class="page-header"><div class="page-header-title"><h1>Gerenciamento de Usuários</h1></div><div class="page-header-actions"><button id="refresh-users-btn" class="refresh-btn" title="Atualizar usuários"><span class="material-icons">refresh</span></button><button id="btn-new-user" class="btn btn-danger"><span class="material-icons">add</span> Novo Usuário</button></div></div><div class="card" style="padding:0;"><table class="data-table"><thead><tr><th>Usuário & Email</th><th>Departamento & Cargo</th><th>Score</th><th>Ações</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div><div id="profile-page" class="page-content"><div class="page-header"><h1>Meu Perfil</h1></div><div id="user-profile-content"></div></div><button class="fab" id="fab-new-message" title="Nova Mensagem"><span class="material-icons">add</span></button></main><div id="user-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="user-modal-title">Novo Usuário</h2><span class="material-icons" style="cursor:pointer;" onclick="closeUserModal()">close</span></div><div class="modal-body"><form id="user-form"><input type="hidden" id="user-id"><div class="form-group"><label for="full_name">Nome Completo</label><input type="text" id="full_name" class="input-field" required></div><div class="form-group"><label for="user_email">Email</label><input type="email" id="user_email" class="input-field" required></div><div class="form-group" id="password-group"><label for="user_password">Senha</label><input type="password" id="user_password" class="input-field"></div><div class="form-group"><label for="department">Departamento</label><input type="text" id="department" class="input-field"></div><div class="form-group"><label for="role">Cargo (Admin, RH, etc)</label><input type="text" id="role" class="input-field"></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button><button class="btn btn-danger" onclick="saveUser()">Salvar</button></div></div></div></div>`;
        
        document.addEventListener('DOMContentLoaded', checkUserSession);
        
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast toast-${type}`; const icons = { success: 'check_circle', danger: 'error', warning: 'warning', info: 'info' }; toast.innerHTML = `<span class="material-icons toast-icon">${icons[type]}</span><span class="toast-message">${message}</span><button class="toast-close">&times;</button>`; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 100); const removeToast = () => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }; const timeoutId = setTimeout(removeToast, 5000); toast.querySelector('.toast-close').addEventListener('click', () => { clearTimeout(timeoutId); removeToast(); }); }
        
        async function checkUserSession() {
            applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            themeToggleBtn.style.display = 'flex';
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                await fetchUserProfile(session.user);
                renderAppLayout();
            } else {
                renderAuthLayout();
            }
        }
        
        function renderAuthLayout() { root.innerHTML = authHTML; document.getElementById('login-form').addEventListener('submit', handleLogin); }
        function renderAppLayout() { root.innerHTML = appHTML; setupEventListeners(); showApp(); }

        function setupEventListeners() {
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('new-message-form').addEventListener('submit', sendMessage);
            document.getElementById('btn-new-user')?.addEventListener('click', () => openUserModal(null));
            document.getElementById('fab-new-message').addEventListener('click', openNewMessagePopup);
            document.getElementById('attachment-input').addEventListener('change', handleFileSelection);
            document.querySelectorAll('.nav-link[data-page]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showPage(e.currentTarget.dataset.page); }); });
            document.querySelectorAll('.urgency-selector .btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); document.querySelectorAll('.urgency-selector .btn').forEach(btn => { btn.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'active'); btn.classList.add('btn-secondary'); }); const clickedButton = e.currentTarget; clickedButton.classList.remove('btn-secondary'); clickedButton.classList.add('active'); const priority = clickedButton.dataset.priority; if (priority === 'normal') clickedButton.classList.add('btn-success'); else if (priority === 'important') clickedButton.classList.add('btn-warning'); else if (priority === 'urgent') clickedButton.classList.add('btn-danger'); }); });
            const recipientInput = document.getElementById('destinatario-input');
            if (recipientInput) { recipientInput.addEventListener('input', handleRecipientSearch); recipientInput.addEventListener('keydown', handleRecipientBackspace); }
            document.querySelectorAll('#messages-page .tab-link').forEach(tab => { tab.addEventListener('click', (e) => { const targetId = e.currentTarget.dataset.tab; document.querySelectorAll('#messages-page .tab-link').forEach(t => t.classList.remove('active')); document.querySelectorAll('#messages-page .tab-content').forEach(c => c.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(targetId).classList.add('active'); }); });
            
            const refreshMessagesBtn = document.getElementById('refresh-messages-btn');
            if(refreshMessagesBtn) {
                refreshMessagesBtn.addEventListener('click', async () => {
                    refreshMessagesBtn.disabled = true;
                    refreshMessagesBtn.classList.add('loading');
                    try {
                        await loadMessages();
                        showToast("Caixa de entrada atualizada!", "info");
                    } catch (e) {
                        showToast("Falha ao atualizar.", "danger");
                    } finally {
                        refreshMessagesBtn.classList.remove('loading');
                        refreshMessagesBtn.disabled = false;
                    }
                });
            }

            const refreshUsersBtn = document.getElementById('refresh-users-btn');
            if(refreshUsersBtn) {
                refreshUsersBtn.addEventListener('click', async () => {
                    refreshUsersBtn.disabled = true;
                    refreshUsersBtn.classList.add('loading');
                    try {
                        await loadUsersForAdmin();
                        showToast("Lista de usuários atualizada!", "info");
                    } catch (e) {
                        showToast("Falha ao atualizar usuários.", "danger");
                    } finally {
                        refreshUsersBtn.classList.remove('loading');
                        refreshUsersBtn.disabled = false;
                    }
                });
            }
        }

        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) { showToast('Erro no login: ' + error.message, 'danger'); } else if (data.user) { await fetchUserProfile(data.user); renderAppLayout(); } }
        async function handleLogout() { await supabaseClient.auth.signOut(); currentUserProfile = null; allUsers = []; renderAuthLayout(); }
        
        async function fetchUserProfile(user) {
            const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                currentUserProfile = { ...data, email: user.email };
            } else {
                console.error("Perfil não encontrado:", error);
                currentUserProfile = { id: user.id, email: user.email, full_name: 'Usuário' };
            }
        }

        function showApp() { 
            const appContainer = document.getElementById('app-container'); 
            if(appContainer && currentUserProfile) { 
                appContainer.classList.add('visible'); 
                document.getElementById('admin-section').style.display = (currentUserProfile.role === 'Admin') ? 'block' : 'none'; 
                showPage('dashboard-page'); 
                loadAllDynamicData();
                document.getElementById('dashboard-title').textContent = `Dashboard de ${currentUserProfile.full_name.split(' ')[0]}`;
            } 
        }
        function showPage(pageId) { 
            const appContainer = document.getElementById('app-container'); if (!appContainer) return;
            appContainer.querySelectorAll('.page-content').forEach(page => page.classList.remove('active')); 
            const targetPage = appContainer.querySelector(`#${pageId}`); 
            if (targetPage) targetPage.classList.add('active'); 
            appContainer.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active')); 
            const activeLink = appContainer.querySelector(`.nav-link[data-page="${pageId}"]`); 
            if (activeLink) activeLink.classList.add('active');
            
            // CORREÇÃO: Esconder o FAB na tela de conversa
            document.getElementById('fab-new-message').classList.toggle('hidden', pageId === 'conversation-view-page');

            if(pageId === 'messages-page') loadMessages(); 
        }
        async function loadAllDynamicData() { loadDashboardStats(); loadMessages(); loadUserProfileData(); if (currentUserProfile && currentUserProfile.role === 'Admin') loadUsersForAdmin(); fetchAllUsersForSearch(); }
        
        async function loadDashboardStats() {
            if (!currentUserProfile) return;
            const { data, error } = await supabaseClient.rpc('get_dashboard_stats').single();
            if (error) { 
                console.error('Error fetching dashboard stats:', error); 
                document.getElementById('pending-messages-count').textContent = 'X';
                document.getElementById('urgent-tickets-count').textContent = 'X';
                return;
            }
            document.getElementById('pending-messages-count').textContent = data.pending_messages_count || 0;
            document.getElementById('urgent-tickets-count').textContent = data.urgent_tickets_count || 0;
        }

        // --- NEW RECIPIENT MODAL LOGIC ---
        async function fetchAllUsersForSearch() { 
            // UPDATED: Now fetches department and role too
            const { data, error } = await supabaseClient.from('profiles').select('id, full_name, score, department, role'); 
            if(error) console.error("Erro ao buscar usuários para pesquisa:", error); 
            else allUsers = data ? data.filter(u => u.id !== currentUserProfile.id) : []; 
        }

        function openRecipientModal() {
            const modal = document.getElementById('recipient-modal');
            modal.classList.add('visible');
            populateRecipientFilters();
            applyRecipientFilters(); // Render initial list
        }

        function closeRecipientModal() {
            document.getElementById('recipient-modal').classList.remove('visible');
            renderRecipientPills(); // Sync pill view on close
        }

        function populateRecipientFilters() {
            const depts = [...new Set(allUsers.map(u => u.department).filter(Boolean))].sort();
            const roles = [...new Set(allUsers.map(u => u.role).filter(Boolean))].sort();

            const deptSelect = document.getElementById('filter-dept');
            const roleSelect = document.getElementById('filter-role');
            
            // Keep first option (All)
            deptSelect.innerHTML = '<option value="">Todos Departamentos</option>';
            roleSelect.innerHTML = '<option value="">Todos Cargos</option>';

            depts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = d;
                deptSelect.appendChild(opt);
            });
            roles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.textContent = r;
                roleSelect.appendChild(opt);
            });
        }

        function applyRecipientFilters() {
            const deptFilter = document.getElementById('filter-dept').value;
            const roleFilter = document.getElementById('filter-role').value;
            const textFilter = document.getElementById('filter-text').value.toLowerCase();

            const filtered = allUsers.filter(user => {
                const matchDept = deptFilter === "" || user.department === deptFilter;
                const matchRole = roleFilter === "" || user.role === roleFilter;
                const matchText = user.full_name.toLowerCase().includes(textFilter) || 
                                  (user.role && user.role.toLowerCase().includes(textFilter)) ||
                                  (user.department && user.department.toLowerCase().includes(textFilter));
                return matchDept && matchRole && matchText;
            });

            renderRecipientModalTable(filtered);
        }

        function renderRecipientModalTable(users) {
            const tbody = document.getElementById('recipient-table-body');
            tbody.innerHTML = '';

            users.forEach(user => {
                const isSelected = selectedRecipients.some(r => r.id === user.id);
                const tr = document.createElement('tr');
                tr.onclick = () => toggleRecipientSelection(user);
                if (isSelected) tr.classList.add('selected-row');

                const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';

                tr.innerHTML = `
                    <td style="padding: 0.75rem 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.8rem;">${avatarInitial}</div>
                            <strong>${user.full_name}</strong>
                        </div>
                    </td>
                    <td style="padding: 0.75rem 1rem;">
                        ${user.department ? `<span class="tag-fino" style="background: var(--color-info-bg); color: var(--color-info);">${user.department}</span>` : '-'}
                    </td>
                    <td style="padding: 0.75rem 1rem;">${user.role || '-'}</td>
                    <td style="text-align: center;">
                        <span class="material-icons check-icon">${isSelected ? 'check_circle' : 'radio_button_unchecked'}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('selected-count-display').textContent = `${selectedRecipients.length} selecionados`;
        }

        function toggleRecipientSelection(user) {
            const exists = selectedRecipients.find(r => r.id === user.id);
            if (exists) {
                selectedRecipients = selectedRecipients.filter(r => r.id !== user.id);
            } else {
                selectedRecipients.push(user);
            }
            applyRecipientFilters(); // Re-render table to show new state
        }
        
        function loadUserProfileData() {
            const container = document.getElementById('user-profile-content');
            if (container && currentUserProfile) {
                const avatarInitial = currentUserProfile.full_name ? currentUserProfile.full_name.charAt(0).toUpperCase() : '?';
                const score = currentUserProfile.score || 100;
                const scorePercentage = Math.min((score / 200) * 100, 100);

                container.innerHTML = `
                    <div class="profile-header-card">
                        <div class="profile-avatar-wrapper" onclick="document.getElementById('avatar-upload-input').click()">
                            <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2.5rem;">${avatarInitial}</div>
                            <div class="profile-avatar-overlay"><span class="material-icons">photo_camera</span></div>
                        </div>
                        <input type="file" id="avatar-upload-input" style="display: none;" accept="image/*" onchange="handleAvatarUpload(event)">
                        <div class="profile-info"><h3>${currentUserProfile.full_name}</h3><p>${currentUserProfile.role || 'Membro'}</p></div>
                    </div>
                    <div class="card"><h3 class="card-title"><span class="material-icons">radar</span> Radar de Engajamento</h3>
                        <div>
                            <div class="score-display"><span class="score-label">Meu Score</span><span class="score-value">${score}</span></div>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: ${scorePercentage}%;"></div></div>
                        </div>
                        <div class="profile-metrics">
                            <div class="profile-metric"><h4>--</h4><p>Taxa de Resposta</p></div>
                            <div class="profile-metric"><h4>--</h4><p>Tempo Médio</p></div>
                            <div class="profile-metric"><h4>--</h4><p>Reconhecimentos</p></div>
                        </div>
                    </div>
                    <div class="card"><h3 class="card-title"><span class="material-icons">emoji_events</span> Minhas Conquistas</h3><p style="text-align: center; color: var(--color-text-secondary);">Em breve...</p></div>`;
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            showToast(`Simulando upload da imagem: ${file.name}. Backend a ser implementado.`, 'info');
        }

        function initializeQuillEditor() {
            if (document.getElementById('editor-container') && !quillEditor) {
                const toolbarOptions = [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link'], [{ 'header': [1, 2, 3, false] }], ['clean'] ];
                quillEditor = new Quill('#editor-container', { modules: { toolbar: toolbarOptions }, placeholder: 'Escreva sua mensagem...', theme: 'snow' });
            }
        }
        function openNewMessagePopup() { document.getElementById('new-message-popup').classList.add('visible'); if (!quillEditor) initializeQuillEditor(); }
        function closeNewMessagePopup() { document.getElementById('new-message-popup').classList.remove('visible'); document.getElementById('new-message-form').reset(); selectedRecipients = []; renderRecipientPills(); document.getElementById('recipient-suggestions').style.display = 'none'; if (quillEditor) quillEditor.setContents([]); document.getElementById('tipo-simples').checked = true; toggleChamadoFields(); clearAttachment(); }
        function toggleChamadoFields() { const isChamado = document.getElementById('tipo-chamado').checked; document.getElementById('chamado-fields').style.display = isChamado ? 'flex' : 'none'; }
        function setDueDate(days) { const date = new Date(); date.setDate(date.getDate() + days); document.getElementById('due_date').value = date.toISOString().split('T')[0]; }
        function renderRecipientPills() { const wrapper = document.getElementById('recipient-input-wrapper'); const input = document.getElementById('destinatario-input'); wrapper.querySelectorAll('.recipient-pill').forEach(pill => pill.remove()); selectedRecipients.forEach(user => { const pill = document.createElement('span'); pill.className = 'recipient-pill'; pill.dataset.userId = user.id; pill.innerHTML = `${user.full_name} <span class="pill-remove" onclick="removeRecipient('${user.id}')">&times;</span>`; wrapper.insertBefore(pill, input); }); input.placeholder = selectedRecipients.length > 0 ? '' : 'Para:'; }
        function addRecipient(user) { if (!selectedRecipients.some(r => r.id === user.id)) { selectedRecipients.push(user); renderRecipientPills(); } const input = document.getElementById('destinatario-input'); input.value = ''; input.focus(); document.getElementById('recipient-suggestions').style.display = 'none'; }
        window.removeRecipient = (userId) => { selectedRecipients = selectedRecipients.filter(r => r.id !== userId); renderRecipientPills(); }
        function handleRecipientBackspace(e) { const input = e.target; if (e.key === 'Backspace' && input.value === '' && selectedRecipients.length > 0) { removeRecipient(selectedRecipients[selectedRecipients.length - 1].id); } }
        function handleRecipientSearch(e) { const query = e.target.value.toLowerCase(); const suggestionsContainer = document.getElementById('recipient-suggestions'); if (query.length < 1) { suggestionsContainer.style.display = 'none'; return; } const filteredUsers = allUsers.filter(user => (user.full_name && user.full_name.toLowerCase().includes(query))); suggestionsContainer.innerHTML = ''; if (filteredUsers.length > 0) { filteredUsers.forEach(user => { const item = document.createElement('div'); item.className = 'suggestion-item'; item.textContent = `${user.full_name}`; item.onclick = () => addRecipient(user); suggestionsContainer.appendChild(item); }); suggestionsContainer.style.display = 'block'; } else { suggestionsContainer.style.display = 'none'; } }
        
        function handleFileSelection(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('attachment-preview');
            if (file) {
                selectedFile = file;
                previewContainer.innerHTML = `<span>${file.name}</span> <span class="material-icons remove-attachment" onclick="clearAttachment()">close</span>`;
            } else { clearAttachment(); }
        }
        function clearAttachment() { selectedFile = null; document.getElementById('attachment-input').value = ''; document.getElementById('attachment-preview').innerHTML = ''; }

        async function sendMessage(e) {
            e.preventDefault();
            const sendButton = document.getElementById('btn-send-message');
            if (sendButton.disabled) return;
            if (!currentUserProfile) { showToast("Você precisa estar logado.", 'warning'); return; }
            if (selectedRecipients.length === 0) { showToast("Adicione pelo menos um destinatário.", 'warning'); return; }

            sendButton.disabled = true; sendButton.innerHTML = '<span class="material-icons" style="font-size: 18px; margin-right: 8px;">hourglass_top</span> Enviando...';

            try {
                const formData = new FormData();
                formData.append('p_subject', document.getElementById('assunto').value || "Sem assunto");
                formData.append('p_type', document.querySelector('input[name="message-type"]:checked').value);
                formData.append('p_priority', document.querySelector('.urgency-selector .btn.active').dataset.priority);
                formData.append('p_requires_response', document.getElementById('requires_response').checked);
                const dueDate = document.getElementById('due_date').value;
                if (dueDate) { formData.append('p_due_date', dueDate); }
                formData.append('p_content', quillEditor.root.innerHTML);
                formData.append('p_recipient_ids', JSON.stringify(selectedRecipients.map(u => u.id)));
                if (selectedFile) { formData.append('file', selectedFile); }

                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Usuário não autenticado.");

                const response = await fetch(N8N_SEND_MESSAGE_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                    body: formData
                });

                if (!response.ok) { throw new Error('Falha na comunicação com o servidor n8n.'); }
                
                showToast("Mensagem enviada com sucesso!", 'success'); closeNewMessagePopup();
                await Promise.all([loadUserProfileData(), loadMessages(), loadDashboardStats()]);
            } catch (error) {
                console.error("Erro ao enviar mensagem via n8n:", error);
                showToast("Falha ao enviar mensagem: " + error.message, 'danger');
            } finally {
                sendButton.disabled = false; sendButton.innerHTML = 'Enviar';
            }
        }
        
        function renderMessageTable(conversations, containerId, type) {
            const container = document.getElementById(containerId);
            if (!conversations || conversations.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhuma mensagem aqui.</div>`; return;
            }
            const tableRows = conversations.map(conv => {
                const preview = conv.last_message_content ? conv.last_message_content.replace(/<[^>]*>?/gm, ' ') : '';
                const timestamp = conv.last_message_created_at ? new Date(conv.last_message_created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }) : '';
                
                let who = 'Você mesmo';
                if (type === 'inbox' || type === 'archived') { who = conv.created_by === currentUserProfile.id ? `Para: ${conv.other_participants_names}` : (conv.other_participants_names || conv.last_message_sender_name); } 
                else { who = `Para: ${conv.other_participants_names}`; }

                let priorityTag = '';
                if (conv.priority === 'urgent') priorityTag = `<span class="tag-fino tag-urgent">Urgente</span>`;
                if (conv.priority === 'important') priorityTag = `<span class="tag-fino tag-important">Importante</span>`;
                let metaTagsHTML = '';
                if (conv.due_date) metaTagsHTML += `<span class="tag-icon due-date-tag" title="Prazo"><span class="material-icons">event</span> ${new Date(conv.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>`;
                if (conv.type === 'ticket') {
                    const statusIcon = conv.status === 'resolved' ? 'check_circle' : 'support_agent';
                    const statusTitle = conv.status === 'resolved' ? 'Chamado Resolvido' : 'Chamado';
                    metaTagsHTML += `<span class="tag-icon" title="${statusTitle}"><span class="material-icons">${statusIcon}</span></span>`;
                }
                if (conv.requires_response) metaTagsHTML += '<span class="tag-icon" title="Exige Resposta"><span class="material-icons">reply</span></span>';
                const isUnread = type === 'inbox' && conv.is_unread;
                const rowClass = isUnread ? 'row-unread' : 'row-read';
                let readReceiptHTML = '';
                if (type === 'sent') {
                    const isReadByRecipient = conv.recipient_read_at && new Date(conv.recipient_read_at) >= new Date(conv.last_message_created_at);
                    if (isReadByRecipient) {
                         const readDate = new Date(conv.recipient_read_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                         readReceiptHTML = `<span class="read-receipt read" title="Lida em: ${readDate}"><span class="material-icons">done_all</span></span>`;
                    } else { readReceiptHTML = `<span class="read-receipt delivered" title="Enviada"><span class="material-icons">check</span></span>`; }
                }
                const archiveIcon = conv.is_archived ? 'unarchive' : 'archive';
                const archiveTitle = conv.is_archived ? 'Desarquivar' : 'Arquivar';
                return `<tr class="${rowClass}" data-conversation-id="${conv.id}">
                        <td class="col-who" onclick="openConversation(this.parentElement)">${who}</td>
                        <td class="col-subject" onclick="openConversation(this.parentElement)">${readReceiptHTML}<span class="subject-title">${conv.subject}</span>${priorityTag}<span class="subject-preview"> - ${preview}</span></td>
                        <td class="col-meta" onclick="openConversation(this.parentElement)"><div class="meta-tags">${metaTagsHTML}</div></td>
                        <td class="col-date" onclick="openConversation(this.parentElement)">${timestamp}</td>
                        <td class="col-actions"><button title="${archiveTitle}" onclick="toggleArchive(this, '${conv.id}')"><span class="material-icons">${archiveIcon}</span></button></td>
                    </tr>`;
            }).join('');
            container.innerHTML = `<table class="data-table-fino"><tbody>${tableRows}</tbody></table>`;
        }

        async function loadMessages() {
            if (!currentUserProfile) return;
            const containers = ['inbox-content', 'sent-content', 'archived-content'];
            containers.forEach(id => document.getElementById(id).innerHTML = '<div class="empty-state">Carregando...</div>');
            
            const { data, error } = await supabaseClient.from('user_conversations_view').select('*').order('last_message_created_at', { ascending: false, nulls: 'last' });

            if (error) {
                console.error('Erro ao buscar mensagens:', error);
                const errorMsg = `<div class="empty-state" style="color: var(--color-danger);">Erro ao carregar mensagens.</div>`;
                containers.forEach(id => document.getElementById(id).innerHTML = errorMsg); return;
            }
            const nonArchived = data.filter(conv => !conv.is_archived);
            const archived = data.filter(conv => conv.is_archived);
            const inboxMessages = nonArchived.filter(conv => conv.last_message_sender_id !== currentUserProfile.id || (conv.other_participants_names === null));
            const sentMessages = nonArchived.filter(conv => conv.last_message_sender_id === currentUserProfile.id && conv.other_participants_names !== null);
            renderMessageTable(inboxMessages, 'inbox-content', 'inbox');
            renderMessageTable(sentMessages, 'sent-content', 'sent');
            renderMessageTable(archived, 'archived-content', 'archived');
        }

        async function toggleArchive(buttonElement, conversationId) {
            const row = buttonElement.closest('tr');
            if (row) { row.style.transition = 'opacity 0.3s ease-out'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão expirou.");
                const response = await fetch(N8N_TOGGLE_ARCHIVE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
                if (!response.ok) throw new Error("Falha ao comunicar com o servidor.");
                showToast("Status da conversa alterado.", 'success');
            } catch (e) {
                console.error("Erro ao arquivar:", e.message); showToast("Falha ao arquivar conversa.", 'danger');
                if (row) row.style.opacity = '1';
            }
        }
        
        async function resolveTicket(conversationId) {
            if (!confirm("Tem certeza que deseja marcar este chamado como resolvido? Esta ação não pode ser desfeita.")) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão expirou.");

                const response = await fetch(N8N_RESOLVE_TICKET_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ conversation_id: conversationId })
                });

                if (!response.ok) throw new Error("Falha ao resolver o chamado. Você pode não ter permissão.");
                
                showToast("Chamado resolvido com sucesso!", 'success');
                const rowElement = document.querySelector(`tr[data-conversation-id="${conversationId}"]`);
                if (rowElement) openConversation(rowElement);
                loadDashboardStats();

            } catch(e) {
                console.error("Erro ao resolver chamado:", e.message);
                showToast(e.message, 'danger');
            }
        }

        async function openConversation(rowElement) {
            const conversationId = rowElement.dataset.conversationId;
            if (!conversationId) { showToast('ID da conversa não encontrado.', 'danger'); return; }

            if (rowElement.classList.contains('row-unread')) { rowElement.classList.remove('row-unread'); rowElement.classList.add('row-read'); }

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    fetch(N8N_MARK_AS_READ_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                        body: JSON.stringify({ conversation_id: conversationId })
                    });
                }
            } catch (e) { console.warn("Não foi possível marcar a mensagem como lida:", e.message); }

            showPage('conversation-view-page');
            document.getElementById('conversation-header').innerHTML = '<div class="empty-state">Carregando...</div>';
            document.getElementById('conversation-messages').innerHTML = '<div class="empty-state">Carregando mensagens...</div>';

            const [messagesRes, attachmentsRes, convDataRes] = await Promise.all([
                supabaseClient.from('conversation_messages_view').select('*').eq('conversation_id', conversationId).order('created_at', { ascending: true }),
                supabaseClient.from('message_attachments_view').select('*'),
                supabaseClient.from('user_conversations_view').select('*').eq('id', conversationId).single()
            ]);

            if (messagesRes.error || attachmentsRes.error || convDataRes.error) {
                showToast('Erro ao carregar detalhes da conversa.', 'danger');
                console.error(messagesRes.error || attachmentsRes.error || convDataRes.error);
                document.getElementById('conversation-header').innerHTML = ''; document.getElementById('conversation-messages').innerHTML = '<div class="empty-state">Falha ao carregar.</div>'; return;
            }

            const { data: messages } = messagesRes;
            const { data: allAttachments } = attachmentsRes;
            const { data: convData } = convDataRes;
            
            const headerContainer = document.getElementById('conversation-header');
            let ticketInfoHTML = '';
            let actionButtonsHTML = '';
            
            if (convData.type === 'ticket') {
                let priorityTag = '';
                if (convData.priority === 'urgent') priorityTag = `<span class="tag-fino tag-urgent">Urgente</span>`;
                else if (convData.priority === 'important') priorityTag = `<span class="tag-fino tag-important">Importante</span>`;
                
                const dueDateHTML = convData.due_date ? `<div><span class="material-icons">event</span><strong>Prazo:</strong> ${new Date(convData.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</div>` : '';
                
                if (convData.status === 'resolved') {
                    ticketInfoHTML = `<div class="conversation-ticket-info" style="justify-content:center;"><div><span class="material-icons" style="color: var(--color-success);">check_circle</span><strong>Chamado Resolvido</strong></div></div>`;
                    document.getElementById('reply-form-wrapper').style.display = 'none';
                } else {
                    ticketInfoHTML = `<div class="conversation-ticket-info"><div><span class="material-icons">support_agent</span> <strong>Chamado Aberto</strong></div> <div>${priorityTag}</div> ${dueDateHTML}</div>`;
                    document.getElementById('reply-form-wrapper').style.display = 'block';
                }

                if (convData.created_by === currentUserProfile.id && convData.status === 'open') {
                    actionButtonsHTML = `<button class="btn btn-success" onclick="resolveTicket('${convData.id}')"><span class="material-icons">check_circle</span> Resolver Chamado</button>`;
                }
            } else {
                document.getElementById('reply-form-wrapper').style.display = 'block';
            }

            const creatorProfile = await supabaseClient.from('profiles').select('full_name').eq('id', convData.created_by).single();
            const senderName = creatorProfile.data ? creatorProfile.data.full_name : 'Desconhecido';
            const recipientNames = convData.other_participants_names ? `Você, ${convData.other_participants_names}`.replace(`, ${currentUserProfile.full_name}`, '').replace(`${currentUserProfile.full_name}, `, '') : 'Você';
            
            headerContainer.innerHTML = `
                <div class="conversation-main-header">
                    <button class="btn btn-secondary" onclick="showPage('messages-page'); loadMessages();"><span class="material-icons">arrow_back</span> Voltar</button>
                    <div class="page-header-actions">${actionButtonsHTML}<button class="btn btn-icon" title="Mais opções"><span class="material-icons">more_vert</span></button></div>
                </div>
                <div class="conversation-info-block">
                    <h1>${convData.subject}</h1>
                    <p><strong>De:</strong> ${senderName}</p>
                    <p><strong>Para:</strong> ${recipientNames}</p>
                </div>
                ${ticketInfoHTML}
            `;

            const messagesContainer = document.getElementById('conversation-messages');
            messagesContainer.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUserProfile.id;
                const timestamp = new Date(msg.created_at).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                const msgAttachments = allAttachments.filter(att => att.message_id === msg.id);
                const attachmentsHTML = msgAttachments.map(att => `
                    <div class="message-attachment">
                        <a href="https://drive.google.com/file/d/${att.google_drive_file_id}/view" target="_blank" class="message-attachment-link">
                            <span class="material-icons">attach_file</span>${att.file_name}
                        </a>
                    </div>`).join('');
                return `<div class="message-bubble-wrapper ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble ${isSent ? 'sent' : 'received'}">${msg.content}${attachmentsHTML}</div>
                            <div class="message-metadata">${isSent ? 'Você' : msg.sender_name} • ${timestamp}</div>
                        </div>`;
            }).join('');
            
            messagesContainer.lastElementChild?.scrollIntoView({ behavior: 'smooth' });

            document.getElementById('reply-form').onsubmit = (e) => {
                e.preventDefault();
                showToast('Respostas ainda não implementadas nesta tela.', 'info');
            };
        }

        async function loadUsersForAdmin() {
            const tableBody = document.getElementById('user-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = `<tr><td colspan="4">Carregando usuários...</td></tr>`;
            try {
                // Mantive users_with_email pois você disse que é o código que funciona no seu ambiente
                const { data: users, error } = await supabaseClient.from('users_with_email').select('*');
                if (error) throw error;
                tableBody.innerHTML = users.map(user => {
                    const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';
                    const roleTag = user.role === 'Admin' ? `<span class="user-tag role-admin">Admin</span>` : (user.role ? `<span class="user-tag role">${user.role}</span>` : '');
                    const departmentTag = user.department ? `<span class="user-tag department">${user.department}</span>` : '';
                    return `<tr>
                        <td><div class="user-info-cell"><div class="user-avatar">${avatarInitial}</div><div><div class="user-name">${user.full_name||'N/A'}</div><div class="user-email">${user.email||'N/A'}</div></div></div></td>
                        <td><div class="user-meta-cell"><div class="user-tags">${departmentTag}${roleTag}</div></div></td>
                        <td class="score-cell"><span class="material-icons">star</span> ${user.score||100}</td>
                        <td class="action-buttons">
                            <button class="btn btn-icon" onclick='openUserModal(${JSON.stringify(user)})' title="Editar"><span class="material-icons">edit</span></button>
                            <button class="btn btn-icon" onclick="deleteUser('${user.id}')" title="Excluir"><span class="material-icons">delete</span></button>
                        </td>
                    </tr>`;
                }).join('');
            } catch(error) { 
                console.error("Erro ao carregar usuários:", error);
                tableBody.innerHTML = `<tr><td colspan="4">Erro ao carregar usuários.</td></tr>`;
            }
        }

        function openUserModal(user) { const modal = document.querySelector('#app-container #user-modal'); document.getElementById('user-form').reset(); const userEmailField = document.getElementById('user_email'); const passwordGroup = document.getElementById('password-group'); userEmailField.disabled = !!user; passwordGroup.style.display = user ? 'none' : 'block'; document.getElementById('user_password').required = !user; if (user) { document.getElementById('user-modal-title').textContent = 'Editar Usuário'; document.getElementById('user-id').value = user.id; document.getElementById('full_name').value = user.full_name; userEmailField.value = user.email || ''; document.getElementById('department').value = user.department; document.getElementById('role').value = user.role; } else { document.getElementById('user-modal-title').textContent = 'Novo Usuário'; document.getElementById('user-id').value = ''; } modal.classList.add('visible'); }
        function closeUserModal() { document.querySelector('#app-container #user-modal')?.classList.remove('visible'); }
        
        async function saveUser() {
            const userId = document.getElementById('user-id').value;
            const fullName = document.getElementById('full_name').value;
            const department = document.getElementById('department').value;
            const role = document.getElementById('role').value;
            const email = document.getElementById('user_email').value;
            const password = document.getElementById('user_password').value;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { showToast("Sessão inválida.", 'danger'); return; }
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` };
            const btnSave = document.querySelector('#user-modal .btn-danger');
            btnSave.disabled = true; btnSave.textContent = "Salvando...";
            try {
                if (userId) {
                    const response = await fetch(N8N_UPDATE_USER_URL, { method: 'POST', headers: headers, body: JSON.stringify({ id: userId, full_name: fullName, department: department, role: role }) });
                    if (!response.ok) throw new Error('Falha ao atualizar usuário.'); showToast("Usuário atualizado com sucesso!", 'success');
                } else {
                    if (!password) { throw new Error("Senha é obrigatória para novos usuários."); }
                    const response = await fetch(N8N_CREATE_USER_URL, { method: 'POST', headers: headers, body: JSON.stringify({ email: email, password: password, full_name: fullName, department: department, role: role }) });
                    if (!response.ok) throw new Error('Falha ao criar usuário.'); showToast("Usuário criado com sucesso!", 'success');
                }
                closeUserModal(); loadUsersForAdmin();
            } catch (error) {
                console.error(error); showToast(error.message, 'danger');
            } finally {
                btnSave.disabled = false; btnSave.textContent = "Salvar";
            }
        }

        async function deleteUser(userId) {
            if (!confirm(`Tem certeza que deseja excluir este usuário? Esta ação é irreversível.`)) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            try {
                const response = await fetch(N8N_DELETE_USER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` }, body: JSON.stringify({ id: userId }) });
                if (!response.ok) throw new Error('Falha ao excluir usuário.');
                showToast("Usuário excluído com sucesso!", 'success'); loadUsersForAdmin();
            } catch (error) {
                console.error(error); showToast(error.message, 'danger');
            }
        }
        
        const body = document.body;
        themeToggleBtn.addEventListener('click', () => applyTheme(body.classList.contains('dark-mode') ? 'light' : 'dark'));
        function applyTheme(theme) { body.classList.toggle('dark-mode', theme === 'dark'); localStorage.setItem('theme', theme); }
    </script>
</body>
</html>
